name: Telegram Broadcast Custom Message

on:
  workflow_dispatch:
    inputs:
      message:
        description: 'The message to send to Telegram'
        required: true
        type: string

jobs:
  broadcast:
    name: Broadcast Message
    runs-on: ubuntu-latest

    steps:
      - name: Send Telegram Message
        env:
          # This pulls the token and chat IDs from your GitHub Secrets
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          # Keeping multiple IDs if you have a list, otherwise it will just use the main one
          TELEGRAM_CHAT_IDS: ${{ secrets.TELEGRAM_CHAT_IDS }}
          MESSAGE: ${{ github.event.inputs.message }}
          PARSE_MODE: "Markdown"
        run: |
          # Function to send message to a chat
          send_message() {
            local chat_id="$1"
            echo "Sending message to Chat ID: $chat_id"
            
            # Use the variable instead of the hardcoded token
            RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="$chat_id" \
              -d parse_mode="$PARSE_MODE" \
              --data-urlencode text="$MESSAGE")
            
            # Check if the Telegram API returned an error
            if echo "$RESPONSE" | grep -q '"ok":false'; then
              echo "Error sending to $chat_id: $RESPONSE"
              return 1
            else
              echo "Success: Message sent to $chat_id"
            fi
          }

          # Handle multiple chat IDs if they are comma-separated in your secret
          IFS=',' read -ra ADDR <<< "$TELEGRAM_CHAT_IDS"
          FAILED=0
          for id in "${ADDR[@]}"; do
            # Trim whitespace
            id=$(echo $id | xargs)
            send_message "$id" || FAILED=1
          done

          if [ $FAILED -ne 0 ]; then
            echo "One or more messages failed to send."
            exit 1
          fi
