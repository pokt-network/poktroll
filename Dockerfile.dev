# This Dockerfile is used to build container image for development purposes.
# It intentionally contains no security features, ships with code and troubleshooting tools.

FROM golang:1.24.3 AS base

# Install build dependencies including CGO toolchain
RUN apt update && \
    apt-get install -y \
    build-essential pkg-config \
    ca-certificates net-tools kubernetes-client \
    curl jq yq make vim less dnsutils rsync

# Enable CGO and set build flags for secp256k1
ENV CGO_ENABLED=1
ENV CGO_CFLAGS="-Wno-implicit-function-declaration -Wno-error=implicit-function-declaration"

# enable faster module downloading.
ENV GOPROXY=https://proxy.golang.org

COPY . /pocket

WORKDIR /pocket

# Build pocketd with CGO and ethereum_secp256k1 tags
RUN go build -tags "ethereum_secp256k1" -o /usr/bin/pocketd ./cmd/poktrolld
RUN mv /pocket/bin/ignite /usr/bin/

# Install Cosmovisor
RUN make install_cosmovisor

# These are helpful for testing locally:
# RUN mv bin/pocketd /usr/bin/
# RUN mv bin/ignite /usr/bin/

RUN make localnet_regenesis

EXPOSE 8545
EXPOSE 8546
EXPOSE 8547

ENTRYPOINT ["pocketd"]