# This Dockerfile is used to build container image for development and CI purposes.
# It intentionally contains helpful tooling and the repository source code so that
# workflows like E2E tests can run inside the container image.
# TODO(@olshansky): Split the E2E/config preparation image from the runtime image once CI supports it.

FROM golang:1.24.3 AS base

# Install build dependencies; CGO remains disabled downstream.
RUN apt update && \
    apt-get install -y \
    build-essential pkg-config \
    ca-certificates net-tools kubernetes-client \
    curl jq yq make vim less dnsutils rsync

# CGO builds disabled; rely on pure-Go toolchain for dev containers.
ENV CGO_ENABLED=0

# Enable faster module downloading.
ENV GOPROXY=https://proxy.golang.org

COPY . /pocket

WORKDIR /pocket

RUN mv /pocket/bin/ignite /usr/bin/ && mv /pocket/bin/pocketd /usr/bin/

# Install Cosmovisor (required for configmaps/secret creation jobs)
RUN make install_cosmovisor

# Regenerate localnet artifacts that populate /root/.pocket; fail fast if the
# regenesis does not complete because downstream jobs rely on these files.
RUN make localnet_regenesis

EXPOSE 8545 8546 8547

ENTRYPOINT ["pocketd"]
